_format_version: "3.0"

services:
  # Product Catalog Service
  - name: product-service
    protocol: grpc
    host: product-catalog-service
    port: 8080

  # User Service
  - name: user-service
    protocol: grpc
    host: user-service
    port: 8080

  # Shopping Cart Service
  - name: cart-service
    protocol: grpc
    host: shopping-cart-service
    port: 8080

  # Order Service
  - name: order-service
    protocol: grpc
    host: order-service
    port: 8080
    plugins:
      - name: grpc-gateway
        config:
          proto: /kong/protos/orders.proto

  # Payment Service
  - name: payment-service
    protocol: grpc
    host: payment-service
    port: 8080

  # Notification Service
  - name: notification-service
    protocol: grpc
    host: notification-service
    port: 8080

routes:
  # Product Catalog Routes
  - name: products-list
    paths:
      - /api/v1/products
    methods: [GET, POST]
    service: product-service
    strip_path: true

  - name: products-detail
    paths:
      - /api/v1/products/.~*
    methods: [GET, PUT, DELETE]
    service: product-service
    strip_path: true

  # User Service Routes
  - name: user-register
    paths: [/api/v1/auth/register]
    methods: [POST]
    service: user-service
    strip_path: true

  - name: user-login
    paths: [/api/v1/auth/login]
    methods: [POST]
    service: user-service
    strip_path: true

  - name: user-profile
    paths: [/api/v1/users/profile]
    methods: [GET, PUT]
    service: user-service
    strip_path: true
    plugins:
      - name: jwt

  # Shopping Cart Routes
  - name: cart-view
    paths: [/api/v1/cart]
    methods: [GET, PUT, DELETE]
    service: cart-service
    strip_path: true
    plugins:
      - name: jwt

  # Order Service Routes
  - name: orders
    paths: [/api/v1/orders]
    methods: [GET, POST]
    service: order-service
    strip_path: true

  - name: order-detail
    paths: [/api/v1/orders/.~*]
    methods: [GET, PUT]
    service: order-service
    strip_path: true

  # Payment Service Routes
  - name: payments
    paths: [/api/v1/payments]
    methods: [GET, POST]
    service: payment-service
    strip_path: true
    plugins:
      - name: jwt

  # Notification Service Routes
  - name: notifications
    paths: [/api/v1/notifications]
    methods: [GET]
    service: notification-service
    strip_path: true
    plugins:
      - name: jwt

plugins:
  - name: rate-limiting
    config:
      minute: 100
      policy: local